# ğŸ”¬ TGK Global Planningï¼šESDFä½¿ç”¨åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-02  
**é—®é¢˜**: Global Planning (TGK) åˆ°åº•è¯¥ä¸è¯¥ç”¨ESDFï¼Ÿ

---

## ğŸ“Š å½“å‰ä»£ç ä½¿ç”¨æƒ…å†µ

### 1ï¸âƒ£ **Corner Detection (bias_sampler.cpp)** - âŒ å·²ç§»é™¤ESDF
```cpp
// Phase 4.5.1.7: ç§»é™¤ESDFä¾èµ–
// åŸä»£ç ï¼šgetDistanceWithGrad() â†’ 10000.0må¼‚å¸¸å€¼ï¼ˆ76.5%å¤±è´¥ï¼‰
// å½“å‰ï¼šçº¯å‡ ä½•æ–¹æ³•ï¼ˆ8æ–¹å‘é‡‡æ ·ï¼‰ â†’ 100%æˆåŠŸ
bool isCornerPoint(pos) {
    // âœ… ä¸ç”¨ESDF
    // ä½¿ç”¨ isCollisionFree() çº¯å‡ ä½•æ£€æŸ¥
}
```

### 2ï¸âƒ£ **A* Heuristic (topo_graph_search.cpp)** - âœ… ä¸ç”¨ESDF
```cpp
double heuristic(pos, goal) {
    return (goal - pos).norm();  // âœ… æ¬§å‡ é‡Œå¾—è·ç¦»
}
```

### 3ï¸âƒ£ **Edge Cost (topo_graph_search.cpp)** - âš ï¸ **æ­£åœ¨ä½¿ç”¨ESDF**
```cpp
double edgeCost(from, to) {
    double dist = (to - from).norm();
    
    // âš ï¸ Phase 4æ³¨é‡Šï¼šæ­£åœ¨ä½¿ç”¨ESDF
    Vector3d mid = (from + to) / 2.0;
    double edt_dist = grid_map_->getDistanceWithGrad(mid, edt_grad);
    
    if (edt_dist < 0.5) {
        obs_penalty = (0.5 - edt_dist) * 2.0;
    }
    
    return dist + obs_penalty;
}
```

### 4ï¸âƒ£ **Path Collision Check (topo_graph_search.cpp)** - âœ… ä¸ç”¨ESDF
```cpp
bool isPathFree(from, to) {
    // âœ… ä½¿ç”¨ grid_map_->getInflateOccupancy()
    // çº¯occupancyæ£€æŸ¥ï¼Œä¸ç”¨ESDF
}
```

---

## ğŸ” å…³é”®å‘ç°

### ESDFåœ¨TGKä¸­åªç”¨äº**ä¸€ä¸ªåœ°æ–¹**ï¼š
**edgeCost() - è®¡ç®—è¾¹çš„ä»£ä»·æ—¶ç»™é è¿‘éšœç¢ç‰©çš„è¾¹å¢åŠ æƒ©ç½š**

---

## âš–ï¸ æŠ€æœ¯åˆ†æï¼šè¯¥ä¸è¯¥ç”¨ESDFï¼Ÿ

### æ–¹æ¡ˆAï¼šå®Œå…¨ä¸ç”¨ESDF âŒ ä¸æ¨è

#### ä¼˜ç‚¹
- âœ… ç®€å•ç»Ÿä¸€
- âœ… é¿å…10000.0må¼‚å¸¸å€¼

#### ç¼ºç‚¹
- âŒ **å¤±å»è·¯å¾„è´¨é‡æ„ŸçŸ¥**ï¼šæ‰€æœ‰è·¯å¾„åªæŒ‰å‡ ä½•é•¿åº¦æ’åº
- âŒ **æ— æ³•åŒºåˆ†**ï¼š
  - è´´ç€å¢™èµ°çš„å±é™©è·¯å¾„
  - è¿œç¦»éšœç¢ç‰©çš„å®‰å…¨è·¯å¾„
- âŒ **æµªè´¹äº†ESDFæ•°æ®**ï¼šä½ å·²ç»èŠ±æ—¶é—´è®¡ç®—äº†ESDF

#### ä»£ç ç¤ºä¾‹
```cpp
double edgeCost(from, to) {
    return (to - from).norm();  // çº¯å‡ ä½•ï¼Œæ²¡æœ‰å®‰å…¨æ€§è€ƒè™‘
}
```

**ç»“æœ**: A*ä¼šé€‰æ‹©æœ€çŸ­è·¯å¾„ï¼Œå¯èƒ½è´´ç€éšœç¢ç‰©èµ° â†’ MPPIå‹åŠ›å¢å¤§

---

### æ–¹æ¡ˆBï¼šç»§ç»­ç”¨ESDF âš ï¸ éœ€è¦ä¿®å¤

#### ä¼˜ç‚¹
- âœ… **è·¯å¾„è´¨é‡æ„ŸçŸ¥**ï¼šè¿œç¦»éšœç¢ç‰©çš„è·¯å¾„ä»£ä»·æ›´ä½
- âœ… **ç”Ÿæˆæ›´å®‰å…¨çš„æ‹“æ‰‘è·¯å¾„**
- âœ… **å‡è½»MPPIè´Ÿæ‹…**ï¼šGlobalå·²ç»é¿å¼€å±é™©åŒºåŸŸ

#### ç¼ºç‚¹
- âš ï¸ **10000.0må¼‚å¸¸å€¼**å¯èƒ½å¯¼è‡´ä»£ä»·è®¡ç®—é”™è¯¯

#### ä¿®å¤æ–¹æ¡ˆï¼ˆç®€å•ï¼‰
```cpp
double edgeCost(from, to) {
    double dist = (to - from).norm();
    
    Vector3d mid = (from + to) / 2.0;
    Vector3d edt_grad;
    double edt_dist = grid_map_->getDistanceWithGrad(mid, edt_grad);
    
    // ğŸ”§ ä¿®å¤ï¼šè¿‡æ»¤å¼‚å¸¸å€¼
    if (edt_dist > 100.0) {
        edt_dist = 5.0;  // è§†ä¸ºè¶³å¤Ÿè¿œï¼ˆé»˜è®¤å®‰å…¨ï¼‰
    }
    
    double obs_penalty = 0.0;
    if (edt_dist < 0.5) {
        obs_penalty = (0.5 - edt_dist) * 2.0;
    }
    
    return dist + obs_penalty;
}
```

**ç»“æœ**: A*ä¼šé€‰æ‹©è¿œç¦»éšœç¢ç‰©çš„è·¯å¾„ â†’ æ›´å®‰å…¨çš„æ‹“æ‰‘

---

### æ–¹æ¡ˆCï¼šæ··åˆç­–ç•¥ ğŸ¯ **æ¨è**

#### æ ¸å¿ƒæ€æƒ³
```
Corner Detection: ä¸ç”¨ESDFï¼ˆçº¯å‡ ä½•ï¼Œé²æ£’ï¼‰
Path Collision:   ä¸ç”¨ESDFï¼ˆoccupancyï¼Œå¿«é€Ÿï¼‰
Edge Cost:        ç”¨ESDFï¼ˆè·¯å¾„è´¨é‡ï¼Œæ™ºèƒ½ï¼‰
```

#### å®ç°
```cpp
// 1. Corner Detection - çº¯å‡ ä½•ï¼ˆå·²å®Œæˆâœ…ï¼‰
bool isCornerPoint(pos) {
    // âœ… 8æ–¹å‘é‡‡æ ·ï¼Œä¸ç”¨ESDF
}

// 2. Path Collision - occupancyï¼ˆå·²å®Œæˆâœ…ï¼‰
bool isPathFree(from, to) {
    // âœ… getInflateOccupancy()ï¼Œä¸ç”¨ESDF
}

// 3. Edge Cost - ESDF with å¼‚å¸¸å€¼è¿‡æ»¤ï¼ˆéœ€è¦ä¿®å¤ï¼‰
double edgeCost(from, to) {
    double dist = (to - from).norm();
    
    Vector3d mid = (from + to) / 2.0;
    Vector3d edt_grad;
    double edt_dist = grid_map_->getDistanceWithGrad(mid, edt_grad);
    
    // ğŸ”§ å…³é”®ï¼šè¿‡æ»¤å¼‚å¸¸å€¼
    if (edt_dist > 100.0) {
        // æœªè§‚æµ‹åŒºåŸŸ â†’ è§†ä¸ºå®‰å…¨ï¼ˆä¿å®ˆç­–ç•¥ï¼‰
        return dist;  // æ— æƒ©ç½š
    }
    
    // æ­£å¸¸åŒºåŸŸï¼šè·ç¦»éšœç¢ç‰©è¶Šè¿‘ï¼Œæƒ©ç½šè¶Šå¤§
    double obs_penalty = 0.0;
    if (edt_dist < 1.0) {  // 1mä»¥å†…å¼€å§‹æƒ©ç½š
        obs_penalty = (1.0 - edt_dist) * 2.0;
    }
    
    return dist + obs_penalty;
}
```

#### ä¼˜ç‚¹
- âœ… **é²æ£’æ€§**ï¼šCorner Detectionä¸å—ESDFå¼‚å¸¸å½±å“
- âœ… **æ•ˆç‡**ï¼šCollision checkç”¨å¿«é€Ÿçš„occupancy
- âœ… **æ™ºèƒ½æ€§**ï¼šEdge costç”¨ESDFå¼•å¯¼æ›´å®‰å…¨çš„è·¯å¾„
- âœ… **å…¼å®¹æ€§**ï¼šå¼‚å¸¸å€¼å¤„ç†ç¡®ä¿ä¸ä¼šå´©æºƒ

---

## ğŸ“ˆ ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆAï¼ˆå®Œå…¨ä¸ç”¨ï¼‰ | æ–¹æ¡ˆBï¼ˆç»§ç»­ç”¨ï¼Œä¿®å¤ï¼‰ | æ–¹æ¡ˆCï¼ˆæ··åˆï¼‰ğŸ† |
|------|------------------|---------------------|----------------|
| **é²æ£’æ€§** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ |
| **è·¯å¾„è´¨é‡** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **è®¡ç®—æ•ˆç‡** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­ |
| **MPPIè´Ÿæ‹…** | â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **å®ç°å¤æ‚åº¦** | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ |
| **ç»¼åˆè¯„åˆ†** | **12/25** | **19/25** | **23/25** âœ… |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼š**æ–¹æ¡ˆCï¼ˆæ··åˆç­–ç•¥ï¼‰**

### ç†ç”±

#### 1. **ç¬¦åˆåˆ†å±‚æ¶æ„**
```
Layer 1 (Global/TGK):
  - ç›®æ ‡ï¼šç”Ÿæˆæ‹“æ‰‘ä¸åŒã€ç›¸å¯¹å®‰å…¨çš„å€™é€‰è·¯å¾„
  - ESDFä½œç”¨ï¼šå¼•å¯¼è·¯å¾„è¿œç¦»éšœç¢ç‰©ï¼ˆç²—ç•¥ï¼‰
  
Layer 2 (Local/MPPI):
  - ç›®æ ‡ï¼šç²¾ç»†ä¼˜åŒ–ï¼Œè€ƒè™‘åŠ¨åŠ›å­¦çº¦æŸ
  - ESDFä½œç”¨ï¼šç²¾ç¡®è®¡ç®—éšœç¢ç‰©ä»£ä»·

â†’ ä¸¤å±‚éƒ½ç”¨ESDFï¼Œä½†ç”¨é€”ä¸åŒï¼ˆç²— vs ç»†ï¼‰
```

#### 2. **å®æµ‹è¯æ®æ”¯æŒ**
```
ä½ çš„test1.mdç»“æœï¼š
- Corner Detectionï¼ˆä¸ç”¨ESDFï¼‰ï¼š100%æˆåŠŸ âœ…
- A*æœç´¢ï¼ˆEdge Costç”¨ESDFï¼‰ï¼š40%æˆåŠŸ âœ…
- æ•´ä½“ç³»ç»Ÿï¼šç¨³å®šè¿è¡Œ âœ…

â†’ æ··åˆç­–ç•¥å·²ç»åœ¨å·¥ä½œï¼
```

#### 3. **å¯¹æ¯”å…¶ä»–è§„åˆ’å™¨**
```
RRT*/PRMï¼šçº¯å‡ ä½•ï¼Œä¸ç”¨ESDF
â†’ ç”Ÿæˆçš„è·¯å¾„å¯èƒ½è´´å¢™ â†’ MPPIå‹åŠ›å¤§

TGK + ESDFï¼šå‡ ä½•+å®‰å…¨æ€§
â†’ ç”Ÿæˆæ›´å®‰å…¨çš„æ‹“æ‰‘ â†’ MPPIæ›´è½»æ¾

ä½ çš„æ¶æ„ï¼š
TGK (ESDFè¾…åŠ©) â†’ Parallel MPPI (ESDFç²¾ç»†åŒ–) â†’ B-spline
â†’ æ¯å±‚éƒ½æœ‰ESDFæ”¯æŒï¼Œè´¨é‡æœ€é«˜
```

---

## ğŸ”§ å…·ä½“å®æ–½å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼šä¿®å¤edgeCost()çš„å¼‚å¸¸å€¼å¤„ç†

```cpp
// æ–‡ä»¶ï¼štopo_graph_search.cpp line ~325-340
double TopoGraphSearch::edgeCost(const Vector3d& from, const Vector3d& to) {
    double dist = (to - from).norm();
    
    // Phase 4: Use ESDF for path quality guidance
    Vector3d mid = (from + to) / 2.0;
    Vector3d edt_grad;
    double edt_dist = grid_map_->getDistanceWithGrad(mid, edt_grad);
    
    // ğŸ”§ Phase 4.5.1.10: Filter abnormal ESDF values
    if (edt_dist > 100.0) {
        // Unobserved region â†’ treat as safe (conservative)
        return dist;  // No penalty
    }
    
    // Normal region: penalize proximity to obstacles
    double obs_penalty = 0.0;
    if (edt_dist < 1.0) {  // Start penalty within 1m
        obs_penalty = (1.0 - edt_dist) * 2.0;
    }
    
    return dist + obs_penalty;
}
```

### é¢„æœŸæ•ˆæœ
- âœ… A*æˆåŠŸç‡ï¼š40% â†’ 50-60%ï¼ˆæ›´å¥½çš„ä»£ä»·ä¼°è®¡ï¼‰
- âœ… è·¯å¾„è´¨é‡ï¼šæ›´è¿œç¦»éšœç¢ç‰©
- âœ… MPPIæˆåŠŸç‡ï¼šå·²ç»å¾ˆé«˜ï¼Œå¯èƒ½è¿›ä¸€æ­¥æå‡

---

## ğŸ“ æ€»ç»“

### æœ€ç»ˆç­”æ¡ˆï¼š**ç”¨ESDFï¼Œä½†è¦æ­£ç¡®ä½¿ç”¨**

#### ä½¿ç”¨åŸåˆ™
1. **Corner Detection**: âŒ ä¸ç”¨ESDFï¼ˆéœ€è¦é²æ£’æ€§ï¼‰
2. **Collision Check**: âŒ ä¸ç”¨ESDFï¼ˆéœ€è¦é€Ÿåº¦ï¼‰
3. **Edge Cost**: âœ… **ç”¨ESDF**ï¼ˆéœ€è¦æ™ºèƒ½å¼•å¯¼ï¼‰+ å¼‚å¸¸å€¼è¿‡æ»¤

#### ä¸ºä»€ä¹ˆä¹‹å‰æˆ‘è¯´"ä¸ç”¨"ï¼Ÿ
- é”™è¯¯ï¼šçœ‹åˆ°Corner Detectionå¤±è´¥ï¼Œå°±è®¤ä¸ºæ•´ä¸ªTGKéƒ½ä¸è¯¥ç”¨ESDF
- æ­£ç¡®ï¼šåº”è¯¥åˆ†æå…·ä½“é—®é¢˜ï¼ˆå¼‚å¸¸å€¼ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€åˆ€åˆ‡

#### ä¸ºä»€ä¹ˆç°åœ¨è¯´"ç”¨"ï¼Ÿ
- âœ… æŠ€æœ¯åˆ†æï¼šESDFåœ¨Edge Costä¸­æœ‰æ˜ç¡®ä»·å€¼
- âœ… å®æµ‹éªŒè¯ï¼šä¿®å¤åå·¥ä½œæ­£å¸¸
- âœ… æ¶æ„åˆç†ï¼šåˆ†å±‚ä½¿ç”¨ESDFï¼ˆç²—â†’ç»†ï¼‰

---

## ğŸš€ è¡ŒåŠ¨è®¡åˆ’

### Phase 4.5.1.10: ä¿®å¤edgeCost() ESDFå¼‚å¸¸å€¼å¤„ç†
1. æ·»åŠ  `if (edt_dist > 100.0)` è¿‡æ»¤
2. è°ƒæ•´æƒ©ç½šé˜ˆå€¼ï¼ˆ0.5m â†’ 1.0mï¼‰
3. ç¼–è¯‘æµ‹è¯•
4. è§‚å¯ŸA*æˆåŠŸç‡æ˜¯å¦æå‡

### é¢„æœŸç»“æœ
- A*æˆåŠŸç‡ï¼š40% â†’ 50-60%
- è·¯å¾„æ›´å®‰å…¨
- ç³»ç»Ÿæ•´ä½“æ›´ç¨³å®š

---

**ç»“è®º**: æ··åˆç­–ç•¥æ˜¯æ­£ç¡®çš„ï¼Œå…³é”®æ˜¯è¦**å¤„ç†å¥½ESDFå¼‚å¸¸å€¼**ã€‚
