# Topo-MPPI æ— äººæœºè·¯å¾„è§„åˆ’ç³»ç»Ÿ

## é¡¹ç›®ç®€ä»‹
æœ¬é¡¹ç›®å®ç°äº†åŸºäºæ‹“æ‰‘å¤šè·¯å¾„+MPPIä¼˜åŒ–çš„ä¸‰å±‚æ— äººæœºè·¯å¾„è§„åˆ’ç³»ç»Ÿï¼Œæ”¯æŒå¤æ‚ç¯å¢ƒä¸‹çš„é«˜é²æ£’æ€§è½¨è¿¹ç”Ÿæˆã€‚

- **å…¨å±€å±‚**ï¼šTopoPRMï¼ˆæ‹“æ‰‘è·¯å¾„ç”Ÿæˆï¼Œå¤šæ ·æ€§ï¼‰
- **ä¼˜åŒ–å±‚**ï¼šMPPIï¼ˆåŠ¨åŠ›å­¦è½¨è¿¹å¹¶è¡Œä¼˜åŒ–ï¼‰
- **æ‰§è¡Œå±‚**ï¼šB-splineï¼ˆè½¨è¿¹å¹³æ»‘ä¸å¯è¡Œæ€§ï¼‰

## ğŸ“Š æœ€æ–°æ€§èƒ½ï¼ˆv3.0 Fast-Planner PRMï¼‰

### æ ¸å¿ƒæŒ‡æ ‡
| æŒ‡æ ‡ | v2.0 (åˆ‡çº¿ç‚¹æ³•) | v3.0 (PRM) | æå‡ |
|------|----------------|------------|------|
| **å¤šè·¯å¾„ç”Ÿæˆç‡** | 18.75% | **58.06%** | **+39.31%** âœ… |
| **å¹³å‡è·¯å¾„æ•°** | 1.19 | **1.87** | **+57%** âœ… |
| **MPPIè§¦å‘ç‡** | 18.75% | **58.06%** | **+3å€** âœ… |

### è·¯å¾„åˆ†å¸ƒï¼ˆtest1.mdéªŒè¯ï¼‰
```
v3.0 æ€§èƒ½ (31æ¬¡è§„åˆ’):
  1æ¡è·¯å¾„: 13æ¬¡ (41.9%)
  2æ¡è·¯å¾„: 12æ¬¡ (38.7%) â† æœ€å¸¸è§
  3æ¡è·¯å¾„:  3æ¬¡ ( 9.7%)
  4æ¡è·¯å¾„:  3æ¬¡ ( 9.7%)
```

**è¯¦ç»†åˆ†æ**: å‚è§ [PRM_V3_UPGRADE_SUMMARY.md](PRM_V3_UPGRADE_SUMMARY.md)

---

## ç³»ç»Ÿæ¶æ„
```
EGO-Planner Manager
    â””â”€ STEP 1: Topological Planning (TopoPRM PRM v3.0)
          â”œâ”€ æ¤­çƒè‡ªç”±ç©ºé—´é‡‡æ · (100ç‚¹)
          â”œâ”€ å¯è§æ€§å›¾æ„å»º (102èŠ‚ç‚¹)
          â”œâ”€ DFSå¤šè·¯å¾„æœç´¢ (50æ¡åŸå§‹è·¯å¾„)
          â”œâ”€ æ‹“æ‰‘ç­‰ä»·æ€§å»é‡ (5-13æ¡å”¯ä¸€è·¯å¾„)
          â””â”€ æœ€ä¼˜è·¯å¾„é€‰æ‹© (1-4æ¡æœ€ç»ˆè·¯å¾„)
    â””â”€ STEP 1.5: Parallel MPPI Optimization (å¤šè·¯å¾„å¹¶è¡Œä¼˜åŒ–)
    â””â”€ STEP 3: B-spline Smoothing (ä»…å¹³æ»‘)
```

---

## æ ¸å¿ƒç®—æ³•

### 1. TopoPRM (Fast-Planner PRM v3.0) â­

**ç®—æ³•æµç¨‹**:
```cpp
STEP 1: æ¤­çƒè‡ªç”±ç©ºé—´é‡‡æ ·
  - åœ¨èµ·ç‚¹-ç»ˆç‚¹æ¤­çƒå†…éšæœºé‡‡æ ·100ä¸ªç‚¹
  - æ£€æŸ¥å®‰å…¨è·ç¦» clearance_=0.8m
  - æˆåŠŸç‡: 100%

STEP 2: å¯è§æ€§å›¾æ„å»º
  - åˆ›å»ºstart/goalèŠ‚ç‚¹ + é‡‡æ ·ç‚¹ â†’ 102èŠ‚ç‚¹
  - å¯è§æ€§è¿æ¥ (åŠå¾„é™åˆ¶10m)
  
STEP 3: DFSå¤šè·¯å¾„æœç´¢
  - æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œæœ€å¤š50æ¡åŸå§‹è·¯å¾„
  - æ·±åº¦é™åˆ¶20å±‚

STEP 4: æ‹“æ‰‘ç­‰ä»·æ€§å»é‡
  - 30ç‚¹ç¦»æ•£åŒ–æ¯”å¯¹
  - å»é‡: 50æ¡ â†’ 5-13æ¡å”¯ä¸€è·¯å¾„

STEP 5: æœ€ä¼˜è·¯å¾„é€‰æ‹©
  - è¿‡æ»¤è¶…é•¿è·¯å¾„ (>2.5å€æœ€çŸ­è·¯å¾„)
  - ä¿ç•™8æ¡æœ€çŸ­è·¯å¾„ â†’ å®é™…è¾“å‡º1-4æ¡
```

**å…³é”®å‚æ•°**:
```cpp
max_raw_paths_ = 50;        // DFSæœ€å¤§æœç´¢è·¯å¾„æ•°
reserve_num_ = 8;           // ä¿ç•™è·¯å¾„æ•°é‡
clearance_ = 0.8;           // é‡‡æ ·ç‚¹å®‰å…¨è·ç¦» (m)
sample_inflate_ = 3.0;      // æ¤­çƒè†¨èƒ€å› å­
ratio_to_short_ = 2.5;      // æœ€é•¿è·¯å¾„=æœ€çŸ­è·¯å¾„*2.5
discretize_points_num_ = 30; // æ‹“æ‰‘æ¯”å¯¹ç¦»æ•£åŒ–ç‚¹æ•°
```

### 2. MPPI (å¹¶è¡Œä¼˜åŒ–)
- é‡‡æ ·å¤šæ¡æ‰°åŠ¨è½¨è¿¹ï¼Œè¯„ä¼°æˆæœ¬
- æŒ‡æ•°åŠ æƒå¹³å‡å¾—åˆ°æœ€ä¼˜è½¨è¿¹
- æ”¯æŒè·¯å¾„å¼•å¯¼ä¸å½’ä¸€åŒ–æˆæœ¬é€‰æ‹©
- **è§¦å‘æ¡ä»¶**: å¤šè·¯å¾„æ•°é‡ > 1

### 3. B-spline (è½¨è¿¹å¹³æ»‘)
- ä»…åšè½¨è¿¹å¹³æ»‘ä¸è½»å¾®é¿éšœ
- æ¢¯åº¦ä¸‹é™ä¼˜åŒ–ï¼Œæ”¯æŒreboundæœºåˆ¶

---

## å‚æ•°è°ƒä¼˜å»ºè®®

### PRMå‚æ•°ä¼˜åŒ–ï¼ˆæå‡å¤šè·¯å¾„ç‡è‡³70%+ï¼‰

| å‚æ•° | å½“å‰å€¼ | å»ºè®®å€¼ | æ•ˆæœ |
|------|--------|--------|------|
| `sample_inflate_` | 3.0 | **4.0** | æ‰©å¤§é‡‡æ ·åŒºåŸŸï¼Œå¢åŠ è·¯å¾„å¤šæ ·æ€§ |
| `ratio_to_short_` | 2.5 | **3.5** | ä¿ç•™æ›´å¤šè¾ƒé•¿è·¯å¾„ |
| `discretize_points_num_` | 30 | **20** | å‡å°‘å»é‡ä¸¥æ ¼åº¦ï¼Œä¿ç•™æ›´å¤šè·¯å¾„ |
| `max_raw_paths_` | 50 | **100** | å¢åŠ DFSæœç´¢æ·±åº¦ |

### MPPIå‚æ•°
| å‚æ•° | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| num_samples | 300~500 | é‡‡æ ·è½¨è¿¹æ•° |
| horizon_steps | 15~20 | é¢„æµ‹æ­¥æ•° |

---

## å¿«é€Ÿä¸Šæ‰‹

### ç¼–è¯‘è¿è¡Œ
```bash
cd /home/he/ros_ws/test/topo-mppi
catkin_make
source devel/setup.bash
roslaunch plan_manage run_in_sim.launch
```

### æµ‹è¯•å¯è§†åŒ–
```bash
# å¯åŠ¨MPPIå¯è§†åŒ–æµ‹è¯•
roslaunch plan_manage test_mppi_visualization.launch
```

### æŸ¥çœ‹æµ‹è¯•ç»“æœ
```bash
# æŸ¥çœ‹æœ€æ–°æµ‹è¯•æ—¥å¿—
cat test1.md

# ç»Ÿè®¡æ€§èƒ½
python3 << 'EOF'
import re
with open('test1.md', 'rb') as f:
    content = f.read().decode('utf-8', errors='ignore')
paths = []
lines = content.split('\n')
for i, line in enumerate(lines):
    if 'STEP 5' in line and i+1 < len(lines):
        match = re.search(r':\s+(\d+)\s+\?', lines[i+1])
        if match:
            paths.append(int(match.group(1)))
if paths:
    total = len(paths)
    multi = sum(1 for n in paths if n > 1)
    print(f"å¤šè·¯å¾„ç‡: {multi}/{total} = {multi/total*100:.2f}%")
    print(f"å¹³å‡è·¯å¾„æ•°: {sum(paths)/total:.2f}")
EOF
```

---

## ä»£ç ç»“æ„å¯¼èˆª

### æ ¸å¿ƒæ–‡ä»¶
- `planner/path_searching/src/topo_prm.cpp`  
  TopoPRM PRM v3.0ä¸»å®ç°ï¼ˆ400è¡Œæ–°å¢ï¼Œå®Œæ•´PRMæµç¨‹ï¼‰
  
- `planner/path_searching/include/path_searching/topo_prm.h`  
  PRMç®—æ³•æ¥å£ï¼ˆGraphNodeç»“æ„ä½“ï¼ŒPRMå‚æ•°ï¼Œæ–°æ–¹æ³•å£°æ˜ï¼‰
  
- `planner/path_searching/src/mppi_planner.cpp`  
  MPPIä¸»å®ç°ï¼ˆæ”¯æŒè·¯å¾„å¼•å¯¼ï¼‰
  
- `planner/plan_manage/src/planner_manager.cpp`  
  ä¸‰å±‚é›†æˆè°ƒåº¦ï¼ˆSTEP 1â†’1.5â†’3ï¼‰

### ç¯å¢ƒä¸ä¼˜åŒ–
- `bspline_opt/src/bspline_optimizer.cpp` - B-splineä¼˜åŒ–
- `plan_env/src/grid_map.cpp` - ESDFç¯å¢ƒåœ°å›¾

### æ–‡æ¡£
- `PRM_V3_UPGRADE_SUMMARY.md` - v3.0å‡çº§è¯¦ç»†æ€»ç»“ â­
- `TOPO_UPGRADE_ROADMAP.md` - 4å‘¨æ”¹é€ è®¡åˆ’ï¼ˆå·²å®Œæˆï¼‰
- `test1.md` - æœ€æ–°æµ‹è¯•æ—¥å¿—ï¼ˆ31æ¬¡è§„åˆ’éªŒè¯ï¼‰

---

## ç‰ˆæœ¬å†å²

### v3.0 (2025-01-04) - Fast-Planner PRM â­
- âœ… å¤šè·¯å¾„ç‡: 18.75% â†’ 58.06% (+39.31%)
- âœ… å¹³å‡è·¯å¾„æ•°: 1.19 â†’ 1.87 (+57%)
- âœ… æ¤­çƒè‡ªç”±ç©ºé—´é‡‡æ · (100ç‚¹ï¼Œ100%æˆåŠŸ)
- âœ… å¯è§æ€§å›¾æ„å»º (102èŠ‚ç‚¹)
- âœ… DFSå¤šè·¯å¾„æœç´¢ (50æ¡åŸå§‹è·¯å¾„)
- âœ… æ‹“æ‰‘ç­‰ä»·æ€§å»é‡ (5-13æ¡å”¯ä¸€è·¯å¾„)

### v2.0 (2024-12) - éšœç¢ç‰©åˆ‡çº¿ç‚¹æ³•
- åˆ‡çº¿ç‚¹ç”Ÿæˆ (å¤šæ–¹å‘)
- å±€éƒ¨è´ªå¿ƒæœç´¢
- å¤šè·¯å¾„ç‡: 18.75%
- å­˜åœ¨é—®é¢˜: startâ†’tangentç¢°æ’ç‡é«˜

### v1.0 (2024) - åŸå§‹EGO-Planner
- å•è·¯å¾„B-splineè§„åˆ’
- æ— æ‹“æ‰‘è·¯å¾„

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

### Phase 1: å‚æ•°è°ƒä¼˜ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
- [ ] æ”¾å®½æ‹“æ‰‘å»é‡: `discretize_points_num_ = 20`
- [ ] æ‰©å¤§æ¤­çƒé‡‡æ ·: `sample_inflate_ = 4.0`
- [ ] ä¿ç•™æ›´å¤šè·¯å¾„: `ratio_to_short_ = 3.5`
- [ ] ç›®æ ‡: å¤šè·¯å¾„ç‡ >70%

### Phase 2: ç®—æ³•ä¼˜åŒ–ï¼ˆä¸­æœŸï¼‰
- [ ] è‡ªé€‚åº”é‡‡æ ·ï¼ˆæ ¹æ®ç¯å¢ƒå¤æ‚åº¦ï¼‰
- [ ] å±€éƒ¨é‡é‡‡æ ·ï¼ˆå…³é”®éšœç¢ç‰©åŒºåŸŸï¼‰
- [ ] è·¯å¾„è´¨é‡è¯„ä¼°ï¼ˆå¹³æ»‘åº¦ã€æ›²ç‡ï¼‰

### Phase 3: ç³»ç»Ÿé›†æˆï¼ˆé•¿æœŸï¼‰
- [ ] MPPIå‚æ•°è‡ªé€‚åº”
- [ ] B-splineå¹³æ»‘ä¼˜åŒ–
- [ ] å®æ—¶æ€§èƒ½ä¼˜åŒ– (<5ms)

---

## å‚è€ƒèµ„æ–™

- **Fast-Planner**: https://github.com/HKUST-Aerial-Robotics/Fast-Planner
- **TGK-Planner**: https://github.com/ZJU-FAST-Lab/TGK-Planner
- **åŸå§‹EGO-Planner**: https://github.com/ZJU-FAST-Lab/ego-planner

---

## è®¸å¯è¯
æœ¬é¡¹ç›®åŸºäºEGO-Plannerï¼Œéµå¾ªç›¸åŒçš„å¼€æºè®¸å¯è¯ã€‚

---

**æœ€åæ›´æ–°**: 2025-01-04  
**å½“å‰ç‰ˆæœ¬**: v3.0 Fast-Planner PRM  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡ (test1.md 31æ¬¡è§„åˆ’éªŒè¯)
# EGO-Planner TOPO+MPPI å‡çº§é¡¹ç›®ç°çŠ¶æ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**: å°†åŸEGO-Plannerçš„å•è·¯å¾„è§„åˆ’å‡çº§ä¸ºå¤šæ‹“æ‰‘è·¯å¾„+MPPIå¹¶è¡Œä¼˜åŒ–æ¶æ„  
**å½“å‰çŠ¶æ€**: âš ï¸ **Parallel MPPIæœªå®é™…è¿è¡Œ,ä»ä½¿ç”¨B-splineè¿›è¡Œè·¯å¾„è§„åˆ’**  
**æœ€åæµ‹è¯•**: 2025-10-04 test1.md (120623è¡Œæ—¥å¿—)

---

## ğŸ” å®é™…è¿è¡Œæƒ…å†µ (åŸºäºtest1çœŸå®æ—¥å¿—)

### æ ¸å¿ƒé—®é¢˜

```
[TopoPRM] Generated 1 valid paths from 4 attempts (25.0% success)  â† åªç”Ÿæˆ1æ¡è·¯å¾„
[PlannerManager] Skipping STEP 2: Parallel MPPI already applied     â† MPPIä»æœªè¿è¡Œ!
[PlannerManager] STEP 3: B-spline smoothing (ONLY smoothing, NOT planning!)
iter=13,time(ms)=0.57,rebound.  â† B-splineåœ¨åšç¢°æ’é¿è®©(ä¸æ˜¯"åªå¹³æ»‘")
```

### ç»Ÿè®¡æ•°æ® (å–è‡ªtest1.md 30-60è½®è§„åˆ’)

| æŒ‡æ ‡ | ç»“æœ | é¢„æœŸ |
|------|------|------|
| **TopoPRMæˆåŠŸç‡** | 25-50% (å¤§éƒ¨åˆ†0%) | 75%+ |
| **ç”Ÿæˆè·¯å¾„æ•°é‡** | 1æ¡ | 2-3æ¡ |
| **Parallel MPPIè¿è¡Œ** | **0æ¬¡** (æ¡ä»¶`topo_paths.size()>1`ä»æœªæ»¡è¶³) | æ¯æ¬¡è§„åˆ’ |
| **B-spline reboundæ¬¡æ•°** | 40-50æ¬¡/è§„åˆ’ | åº”ä¸º0(è·¯å¾„å·²ä¼˜åŒ–) |
| **MPPIå®é™…è¿è¡Œ** | ä»…1æ¬¡(#46è½®,2æ¡è·¯å¾„) | åº”ä¸ºå¸¸æ€ |

### å…¸å‹å¤±è´¥æ¨¡å¼

**æ¨¡å¼1**: å…¨éƒ¨åˆ‡ç‚¹è¢«æ‹’ç» (0% success)
```
Obstacle #1: generated 2 tangent points
  âŒ Rejected tangent #1: startâ†’tangent=COLLISION, tangentâ†’goal=OK
  âŒ Rejected tangent #2: startâ†’tangent=COLLISION, tangentâ†’goal=OK
Obstacle #2: generated 2 tangent points  
  âŒ Rejected tangent #1: startâ†’tangent=COLLISION, tangentâ†’goal=OK
  âŒ Rejected tangent #2: startâ†’tangent=COLLISION, tangentâ†’goal=OK
Generated 0 valid paths from 4 attempts (0.0% success)
```

**æ¨¡å¼2**: éƒ¨åˆ†åˆ‡ç‚¹é€šè¿‡ (25-50% success)
```
Obstacle #1: generated 2 tangent points
  âŒ Rejected tangent #1: startâ†’tangent=COLLISION, tangentâ†’goal=OK
  âœ… Path 1: via [-13.51, 8.88, 0.81], cost=37.746
Generated 1 valid paths from 2 attempts (50.0% success)  â† ä»ä¸æ»¡è¶³>1æ¡ä»¶
```

---

## ğŸ› ï¸ å·²å®ç°çš„ä¿®å¤

### ä¿®å¤1: TopoPRMåˆ‡çº¿ç‚¹ç”Ÿæˆä¼˜åŒ– (å·²ä¿®æ”¹,æ•ˆæœæœ‰é™)

**é—®é¢˜è¯Šæ–­**:
- **100%çš„å¤±è´¥**éƒ½æ˜¯`startâ†’tangent=COLLISION`
- åˆ‡çº¿ç‚¹è·ç¦»éšœç¢ç‰©å¤ªè¿‘,å¯¼è‡´èµ·ç‚¹åˆ°åˆ‡ç‚¹çš„ç›´çº¿ç©¿è¿‡éšœç¢ç‰©

**ä¿®æ”¹å†å²**:
```cpp
// v1 (åŸå§‹): å¤ªä¸¥æ ¼
double avoidance_radius = search_radius_ * 1.2;  // 1.2å€
if (dist < direct_dist * 1.8 && !collision) { ... }  // 1.8å€

// v2 (ç¬¬ä¸€æ¬¡æ”¾å®½): æ•ˆæœä¸æ˜æ˜¾
double avoidance_radius = search_radius_ * 1.5;  // 1.5å€  
if (dist < direct_dist * 2.5 && !collision) { ... }  // 2.5å€

// v3 (å»ºè®®ä½†æœªæµ‹è¯•): è¿›ä¸€æ­¥æ”¾å®½
double avoidance_radius = search_radius_ * 2.0;  // 2.0å€
```

**ç»“æœ**: æˆåŠŸç‡ä»25%æå‡åˆ°25-50%,**ä»æœªè¾¾åˆ°ç›®æ ‡**

### ä¿®å¤2: MPPIè·¯å¾„å¼•å¯¼åŠŸèƒ½ (å·²å®ç°,ä½†MPPIæœªè¿è¡Œ)

**ä¿®æ”¹æ–‡ä»¶**:
```cpp
// mppi_planner.h - æ·»åŠ é‡è½½å‡½æ•°
bool planTrajectory(const Eigen::Vector3d& start_pos, const Eigen::Vector3d& start_vel,
                   const Eigen::Vector3d& goal_pos, const Eigen::Vector3d& goal_vel,
                   const std::vector<Eigen::Vector3d>& initial_path,  // æ–°å¢å¼•å¯¼è·¯å¾„
                   MPPITrajectory& result);

// mppi_planner.cpp - å®ç°å¼•å¯¼ç‰ˆrollout
void rolloutTrajectory(..., const vector<Vector3d>& guide_path, ...) {
    // ä½¿ç”¨guide_pathåˆå§‹åŒ–è½¨è¿¹,é¿å…éšæœºæ€§
}

// planner_manager.cpp Line 318 - ä¼ å…¥topoè·¯å¾„
bool mppi_success = mppi_planner_->planTrajectory(start, vel, goal, vel,
                                                  dense_path, result);
```

**çŠ¶æ€**: ä»£ç å®Œæˆ,ä½†å› MPPIä»æœªè¿è¡Œè€Œæ— æ³•éªŒè¯æ•ˆæœ

### ä¿®å¤3: Parallel MPPIå®Œæ•´å®ç°

**åŠŸèƒ½**: å¯¹å¤šæ¡æ‹“æ‰‘è·¯å¾„å¹¶è¡Œè¿è¡ŒMPPIä¼˜åŒ–

```cpp
if (use_parallel_mppi && mppi_planner_ != nullptr && topo_paths.size() > 1) {
    // å¯¹æ¯æ¡è·¯å¾„è¿è¡ŒMPPI
    for (size_t i = 0; i < topo_paths.size(); ++i) {
        mppi_planner_->planTrajectory(..., dense_path, candidate.mppi_result);
        // è®¡ç®—å½’ä¸€åŒ–ä»£ä»· (cost / path_length)
    }
    // é€‰æ‹©å½’ä¸€åŒ–ä»£ä»·æœ€ä½çš„è·¯å¾„
}
```

**å®é™…è¿è¡Œæƒ…å†µ**: 
- **ä»…è¿è¡Œ1æ¬¡** (#46è½®,å½“TopoPRMç”Ÿæˆ2æ¡è·¯å¾„æ—¶)
- è¯æ˜ä»£ç åŠŸèƒ½æ­£å¸¸,ä½†è¾“å…¥æ¡ä»¶(>1è·¯å¾„)å‡ ä¹ä¸æ»¡è¶³

### ä¿®å¤4: å¯è§†åŒ–å¢å¼º

**ä¸‰è‰²ç¼–ç ç³»ç»Ÿ**:
- ğŸ”´ çº¢è‰² (Path #0): æœ€ä½³è·¯å¾„
- ğŸŸ¢ ç»¿è‰² (Path #1): æ¬¡ä¼˜è·¯å¾„  
- ğŸ”µ è“è‰² (Path #2): ç¬¬ä¸‰è·¯å¾„

**å±‚æ¬¡**:
- TOPOåŸå§‹è·¯å¾„: åŠé€æ˜ç»†çº¿
- MPPIä¼˜åŒ–è·¯å¾„: ä¸é€æ˜ç²—çº¿

**å‘å¸ƒè¯é¢˜**: `/topo_mppi_paths` (MarkerArray)

**å®é™…æ•ˆæœ**: å› åªæœ‰1æ¡è·¯å¾„,åªèƒ½çœ‹åˆ°çº¢è‰²

---

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### å·²åˆ é™¤æ–‡ä»¶ (TGKç³»ç»Ÿ,7%æå‡,ä¸ç¬¦åˆé¢„æœŸ)

```bash
src/planner/path_searching/src/bias_sampler.cpp          # åˆ é™¤
src/planner/path_searching/src/topo_graph_search.cpp     # åˆ é™¤  
include/path_searching/bias_sampler.h                    # åˆ é™¤
include/path_searching/topo_graph_search.h               # åˆ é™¤
```

### æ ¸å¿ƒä¿®æ”¹æ–‡ä»¶

**1. topo_prm.cpp** (æ‹“æ‰‘è·¯å¾„ç”Ÿæˆ)
- Line 137-142: æ”¾å®½åˆ‡çº¿ç‚¹è¿‡æ»¤ (1.2â†’1.5å€åŠå¾„, 1.8â†’2.5å€è·ç¦»)
- Line 145-165: æ·»åŠ æ®µçº§ç¢°æ’æ£€æµ‹æ—¥å¿— (`startâ†’tangent`, `tangentâ†’goal`)
- åŠŸèƒ½: ç”Ÿæˆ4æ–¹å‘åˆ‡çº¿è·¯å¾„ (left/right/up/down)
- å½“å‰é—®é¢˜: `startâ†’tangent` æ®µç¢°æ’ç‡75%

**2. mppi_planner.h/cpp** (MPPIä¼˜åŒ–å™¨)
- æ–°å¢: `planTrajectory()` é‡è½½ç‰ˆæœ¬ (å¸¦initial_pathå‚æ•°)
- æ–°å¢: `rolloutTrajectory()` è·¯å¾„å¼•å¯¼ç‰ˆæœ¬
- çŠ¶æ€: ä»£ç å®Œæˆ,æœªå®é™…æµ‹è¯• (MPPIæœªè¿è¡Œ)

**3. planner_manager.cpp** (è§„åˆ’ç®¡ç†å™¨)
- Line 275-380: Parallel MPPIå®Œæ•´å®ç°
  - éå†æ‰€æœ‰topoè·¯å¾„
  - å¯¹æ¯æ¡è·¯å¾„è¿è¡ŒMPPIä¼˜åŒ–  
  - è®¡ç®—å½’ä¸€åŒ–ä»£ä»· (cost/length)
  - é€‰æ‹©æœ€ä¼˜è·¯å¾„
- Line 318: ä¼ å…¥dense_pathå¼•å¯¼MPPI
- Line 478-490: B-splineæ—¥å¿—å¢å¼º (æš´éœ²reboundäº‹å®)
- Line 799-850: TOPO+MPPIå¯è§†åŒ–å‡½æ•°

**4. planner_manager.h**
- æ–°å¢: `visualizeTopoMPPIPaths()` å‡½æ•°å£°æ˜
- æ–°å¢: `topo_mppi_vis_pub_` å‘å¸ƒå™¨
- æ–°å¢: `use_parallel_mppi_optimization` å‚æ•°

**5. CMakeLists.txt** (path_searching package)
- åˆ é™¤: TGKç›¸å…³æºæ–‡ä»¶å¼•ç”¨
- ä¿ç•™: TopoPRM + MPPIåŒç³»ç»Ÿ

---

## ğŸ› æ ¹æœ¬é—®é¢˜åˆ†æ

### é—®é¢˜é“¾

```
TopoPRMåˆ‡çº¿ç‚¹è·ç¦»éšœç¢ç‰©å¤ªè¿‘
    â†“
èµ·ç‚¹â†’åˆ‡ç‚¹æ®µç©¿è¿‡éšœç¢ç‰© (75%å¤±è´¥)  
    â†“
åªç”Ÿæˆ1æ¡æœ‰æ•ˆè·¯å¾„
    â†“  
ä¸æ»¡è¶³Parallel MPPIæ¡ä»¶ (topo_paths.size() > 1)
    â†“
MPPIä»æœªè¿è¡Œ
    â†“
B-splineæ‰¿æ‹…è·¯å¾„è§„åˆ’å·¥ä½œ (40æ¬¡reboundè¿­ä»£)
    â†“
æ•´ä¸ªTOPO+MPPIå‡çº§æœªå®é™…å¯ç”¨
```

### å…³é”®æŒ‡æ ‡å·®è·

| æ¨¡å— | è®¾è®¡é¢„æœŸ | å®é™…è¡¨ç° | å·®è· |
|------|---------|---------|------|
| TopoPRMç”Ÿæˆè·¯å¾„ | 2-3æ¡ | 1æ¡ | **æœªè¾¾æ ‡** |
| åˆ‡ç‚¹æˆåŠŸç‡ | 75%+ | 25-50% | **æœªè¾¾æ ‡** |
| MPPIè¿è¡Œé¢‘ç‡ | æ¯æ¬¡è§„åˆ’ | 0.03% (1/30è½®) | **æœªè¾¾æ ‡** |
| B-splineè§’è‰² | ä»…å¹³æ»‘ | è·¯å¾„è§„åˆ’+é¿éšœ | **æœªè¾¾æ ‡** |

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ–¹å‘ (3ä¸ªé€‰é¡¹)

### é€‰é¡¹1: ç»§ç»­ä¼˜åŒ–TopoPRM (å·¥ä½œé‡å¤§,æˆåŠŸç‡ä¸ç¡®å®š)

**éœ€è¦åš**:
1. å¢å¤§é¿éšœåŠå¾„åˆ°2.0-2.5å€
2. å¢åŠ åˆ‡çº¿æ–¹å‘ (8æ–¹å‘: 4æ–œè§’+4æ­£äº¤)
3. å¤šå±‚é‡‡æ · (è¿‘/ä¸­/è¿œä¸‰ä¸ªè·ç¦»å±‚)
4. è‡ªé€‚åº”è·ç¦»åˆ¤æ–­

**é¢„æœŸ**:
- æˆåŠŸç‡æå‡åˆ°60-80%
- å¤§éƒ¨åˆ†è§„åˆ’ç”Ÿæˆ2æ¡è·¯å¾„
- Parallel MPPIè¿è¡Œé¢‘ç‡40-60%

**é£é™©**: å¯èƒ½ä»æ— æ³•ç¨³å®šè¾¾åˆ°>1è·¯å¾„

### é€‰é¡¹2: æ”¹ç”¨æˆç†Ÿæ‹“æ‰‘ç®—æ³• (æ¨è)

**å€™é€‰ç®—æ³•**:
- **Jump Point Search (JPS)**: è·¯å¾„å¤šæ ·æ€§å¥½
- **Theta\***: æ”¯æŒany-angleè·¯å¾„
- **ORCA** (Optimal Reciprocal Collision Avoidance): å¤šè·¯å¾„ç”Ÿæˆ

**ä¼˜åŠ¿**:
- æˆç†Ÿç¨³å®š,æœ‰ç†è®ºä¿è¯
- è‡ªç„¶ç”Ÿæˆå¤šæ¡å¼‚æ„è·¯å¾„
- ä¸ä¾èµ–æ‰‹å·¥è°ƒå‚

**å·¥ä½œé‡**: 2-3å‘¨é›†æˆæµ‹è¯•

### é€‰é¡¹3: æ”¾å¼ƒParallel MPPI,æ”¹ç”¨å¢å¼ºB-spline

**æ€è·¯**:
- æ‰¿è®¤B-splineå·²åœ¨åšè·¯å¾„è§„åˆ’
- å¼ºåŒ–B-splineçš„é¿éšœèƒ½åŠ›
- åˆ é™¤æœªä½¿ç”¨çš„TOPO+MPPIä»£ç 
- å›åˆ°ç®€åŒ–æ¶æ„

**ä¼˜åŠ¿**:
- ä»£ç ç®€å•æ¸…æ™°
- æ— éœ€è°ƒè¯•å¤šè·¯å¾„ç”Ÿæˆ
- æ€§èƒ½å¯èƒ½æ›´å¥½ (å‡å°‘å†—ä½™è®¡ç®—)

**åŠ£åŠ¿**: å¤±å»å¤šè·¯å¾„æ¢ç´¢èƒ½åŠ›

---

## ğŸ“Š Test1æ—¥å¿—æ‘˜è¦

**æµ‹è¯•æ—¶é—´**: 2025-10-04  
**æ€»è§„åˆ’è½®æ¬¡**: 62è½®  
**æ—¥å¿—è¡Œæ•°**: 120,623è¡Œ

**å…³é”®å‘ç°**:
1. **#30è½®**: 0% success, 0æ¡è·¯å¾„, å…¨éƒ¨startâ†’tangentç¢°æ’
2. **#31è½®**: 50% success, 1æ¡è·¯å¾„, MPPIè·³è¿‡
3. **#46è½®**: **50% success, 2æ¡è·¯å¾„, MPPIå®é™…è¿è¡Œ!**
   ```
   Found 2 topological paths
   ğŸš€ Optimizing all 2 topological paths...
   Path 1: MPPI âœ… cost=3795.003, norm_cost=612.737
   Path 2: MPPI âœ… cost=4271.003, norm_cost=609.805  
   ğŸ† Best MPPI: Path #2 with normalized_cost=609.805
   ```
4. **#50-54è½®**: å¤šæ¬¡rebound (10-45æ¬¡), B-splineåœ¨åšè·¯å¾„è§„åˆ’

**B-splineå·¥ä½œè¯æ®**:
```
iter=13,time(ms)=0.57,rebound.    â† ç¢°æ’åå¼¹13æ¬¡
iter=18,time(ms)=0.54,rebound.    â† åˆåå¼¹18æ¬¡
iter(+1)=30,time(ms)=0.049,total_t(ms)=1.169,cost=0.327
```

è¿™ä¸æ˜¯"smoothing",è¿™æ˜¯**path planning with obstacle avoidance**ã€‚

---

## ğŸ’¬ æ€»ç»“é™ˆè¿°

**ç°çŠ¶**: 
- TOPO+MPPIå‡çº§çš„æ ¸å¿ƒåŠŸèƒ½(Parallel MPPI)åœ¨99.97%çš„è§„åˆ’ä¸­æœªè¿è¡Œ
- B-splineä»åœ¨æ‰¿æ‹…è·¯å¾„è§„åˆ’ä¸»è¦å·¥ä½œ (reboundè¿­ä»£40-50æ¬¡)
- æ¶æ„å‡çº§æœªè¾¾åˆ°é¢„æœŸæ•ˆæœ

**æ ¹æœ¬åŸå› **:
- TopoPRMåˆ‡çº¿ç‚¹ç”Ÿæˆç®—æ³•åœ¨å®é™…ç¯å¢ƒä¸­æˆåŠŸç‡è¿‡ä½ (25-50%)
- æ— æ³•ç¨³å®šç”Ÿæˆ>1æ¡è·¯å¾„,å¯¼è‡´Parallel MPPIè§¦å‘æ¡ä»¶ä¸æ»¡è¶³

**å»ºè®®**:
- é€‰é¡¹2 (æ¢ç”¨æˆç†Ÿæ‹“æ‰‘ç®—æ³•) - å¦‚æœç»§ç»­å¤šè·¯å¾„æ–¹å‘
- é€‰é¡¹3 (ç®€åŒ–æ¶æ„) - å¦‚æœæ¥å—å•è·¯å¾„æ–¹æ¡ˆ

**å½“å‰ä»£ç ä»·å€¼**:
- Parallel MPPIæ¡†æ¶å®Œæ•´å¯ç”¨ (#46è½®è¯æ˜åŠŸèƒ½æ­£å¸¸)
- å¯è§†åŒ–ç³»ç»Ÿå®Œå–„
- è·¯å¾„å¼•å¯¼MPPIå·²å®ç° (å¾…æµ‹è¯•)
- å¯ä½œä¸ºæœªæ¥é›†æˆå…¶ä»–æ‹“æ‰‘ç®—æ³•çš„åŸºç¡€
**é—®é¢˜**: åªæ˜¾ç¤ºMPPIæˆåŠŸçš„è·¯å¾„,å¤±è´¥çš„çœ‹ä¸åˆ°
```cpp
// âœ… ç°åœ¨æ‰€æœ‰è·¯å¾„éƒ½æ˜¾ç¤º
if (mppi_success) {
    // MPPIæˆåŠŸ: æ˜¾ç¤ºä¼˜åŒ–åè·¯å¾„
} else {
    // MPPIå¤±è´¥: æ˜¾ç¤ºtopoåŸå§‹è·¯å¾„
}
visualizeTopoMPPIPaths(i, topo_path, mppi_result, false);  // éƒ½æ˜¾ç¤º
```

### ä¿®å¤4: å¯è§†åŒ–æ”¹è¿›
- TOPOè·¯å¾„: ç»†çº¿(0.10m), åŠé€æ˜(alpha=0.5)
- MPPIè·¯å¾„: ç²—çº¿(0.15m), ä¸é€æ˜(alpha=0.8)
- æœ€ä¼˜è·¯å¾„: æœ€ç²—(0.25m), å®Œå…¨ä¸é€æ˜(alpha=1.0)
- ä¸åŒpath_idè‡ªåŠ¨åˆ†é…10ç§é¢œè‰²

### ä¿®å¤5: B-splineæ—¥å¿—æ”¹è¿›
**é—®é¢˜**: B-splineä¸æ˜¯"åªå¹³æ»‘",åœ¨åšç¢°æ’é¿è®©(rebound)
**ä¿®æ”¹**: æ·»åŠ è¯¦ç»†æ—¥å¿—,æ ‡æ˜B-splineåœ¨åšä»€ä¹ˆ
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[PlannerManager] STEP 3: B-spline smoothing (ONLY smoothing, NOT planning!)
[PlannerManager]   Input: 3 control points from TOPO/MPPI
iter=40,time(ms)=0.61,rebound.  â† åœ¨é¿éšœ!
[PlannerManager]   B-spline result: âœ… SUCCESS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ› å·²çŸ¥BUG (å·²ä¿®å¤)


### BUG #1: MPPIå…¨æ˜¯çº¢çº¿ âœ… å·²ä¿®å¤
**åŸå› **: MPPIæ²¡æ¥æ”¶topoè·¯å¾„,ä»åŒä¸€åˆå§‹è½¨è¿¹ä¼˜åŒ–
**ä¿®å¤**: æ·»åŠ å¼•å¯¼ç‰ˆplanTrajectory,ä¼ å…¥dense_path

### BUG #2: åªçœ‹åˆ°1æ¡è·¯å¾„ âœ… å·²ä¿®å¤
**åŸå› **: åªæ˜¾ç¤ºMPPIæˆåŠŸçš„è·¯å¾„
**ä¿®å¤**: MPPIå¤±è´¥æ—¶ç”¨topoè·¯å¾„fallback,æ‰€æœ‰è·¯å¾„éƒ½å¯è§†åŒ–

### BUG #3: B-splineå¤§å¹…æ”¹è·¯å¾„
**è¯´æ˜**: B-splineåªåº”å¹³æ»‘,å¦‚æœå¤§æ”¹è¯´æ˜TOPO/MPPIå¤±è´¥
**çŠ¶æ€**: å¾…æµ‹è¯•éªŒè¯

---

## ğŸ“Š è¿è¡Œæµ‹è¯•

### ç¼–è¯‘
```bash
cd /home/he/ros_ws/test/ego-planner
catkin build plan_manage path_searching -DCMAKE_BUILD_TYPE=Release
```

### è¿è¡Œ
```bash
roslaunch ego_planner simple_run.launch
```

### æŸ¥çœ‹å…³é”®æ—¥å¿—
ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰“å°æ¸…æ™°çš„åˆ†éš”çº¿å’ŒçŠ¶æ€:

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[TopoPRM] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[TopoPRM] Finding paths: [x,y,z] â†’ [x,y,z]
[TopoPRM] Sampled 50 points, found 3 obstacles
[TopoPRM] After filtering: 2 obstacle centers
[TopoPRM] Obstacle at [x,y,z]: generated 4 tangent points
[TopoPRM] âœ… Tangent path 1: cost=12.3 via [x,y,z]
[TopoPRM] Generated 3 valid paths from 8 attempts (37.5% success)
[TopoPRM] â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[PlannerManager] STEP 1: Topological Planning
[PlannerManager]   Found 3 topological paths

[PlannerManager] STEP 2: Parallel MPPI Optimization
[PlannerManager]   ğŸš€ Optimizing all 3 topological paths...
[PlannerManager]   Path 1/3: Running MPPI...
[MPPI] Guided trajectory with cost: 45.2 (using 7 waypoints)
[PlannerManager]   Path 1: MPPI âœ… cost=45.2, norm_cost=2.1, length=21.5m
[PlannerManager]   Path 2/3: Running MPPI...
[PlannerManager]   Path 2: MPPI âœ… cost=38.6, norm_cost=1.8, length=21.4m
[PlannerManager]   Path 3/3: Running MPPI...
[PlannerManager]   Path 3: MPPI âŒ failed

[PlannerManager]   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[PlannerManager]   ğŸ† Best MPPI: Path #2 with normalized_cost=1.8
[PlannerManager]   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[PlannerManager]   Using MPPI result with 52 points
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[PlannerManager] STEP 3: B-spline smoothing (ONLY smoothing, NOT planning!)
[PlannerManager]   Input: 52 control points from TOPO/MPPI
[PlannerManager]   B-spline result: âœ… SUCCESS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### è¯Šæ–­é—®é¢˜

**å¦‚æœåªçœ‹åˆ°1æ¡çº¢è·¯å¾„**:
```bash
# æ£€æŸ¥éšœç¢ç‰©æ£€æµ‹
grep "TopoPRM.*obstacles" ~/.ros/log/latest/*.log

# æ£€æŸ¥è·¯å¾„ç”Ÿæˆ
grep "Generated.*valid paths" ~/.ros/log/latest/*.log

# æ£€æŸ¥MPPIçŠ¶æ€
grep "Path.*MPPI" ~/.ros/log/latest/*.log
```

**å¯èƒ½åŸå› **:
1. `After filtering: 0 obstacle centers` â†’ æ²¡éšœç¢ç‰©,åªæœ‰ç›´çº¿
2. `Generated 0 valid paths` â†’ åˆ‡ç‚¹ç¢°æ’,æ— æ³•ç”Ÿæˆ
3. `Path 1: MPPI âœ…` ä½†å…¶ä»–å…¨å¤±è´¥ â†’ MPPIå‚æ•°é—®é¢˜

---

## ğŸ¨ RVizå¯è§†åŒ–

### æ·»åŠ Topic
1. ç‚¹å‡» "Add" â†’ "By topic"
2. é€‰æ‹© `/topo_mppi_paths` â†’ `MarkerArray`
3. ç¡®ä¿Frameè®¾ç½®ä¸º"world"

### é¢„æœŸæ˜¾ç¤º
- ğŸ”´ è·¯å¾„0: çº¢è‰²ç»†TOPO + çº¢è‰²ç²—MPPI
- ğŸŸ¢ è·¯å¾„1: ç»¿è‰²ç»†TOPO + **ç»¿è‰²æœ€ç²—MPPI** (æœ€ä¼˜)
- ğŸ”µ è·¯å¾„2: è“è‰²ç»†TOPO + è“è‰²ç²—MPPI
- ğŸ† é»„è‰²æ ‡ç­¾: "BEST PATH #1"

---

## ï¿½ï¸ å·²åˆ é™¤

**TGKç®—æ³•** (å¤±è´¥3å¤©,0%æ”¹è¿›):
- `bias_sampler.cpp/h`
- `topo_graph_search.cpp/h`

**æ— ç”¨æ–‡æ¡£** (8ä¸ª.mdæ–‡ä»¶):
- `ALGORITHM_ARCHITECTURE_SUMMARY.md`
- `VISUALIZATION_*.md` (4ä¸ª)
- `CRITICAL_ISSUES_FOUND.md`
- ç­‰

---

## ğŸ“ ä»£ç ä¿®æ”¹è®°å½•

| æ–‡ä»¶ | ä¿®æ”¹ | åŸå›  |
|------|------|------|
| `topo_prm.cpp` | åˆ é™¤Circular/Vertical/Alternativeç­–ç•¥ | å†—ä½™,åªä¿ç•™Tangent |
| `mppi_planner.h` | æ·»åŠ å¸¦initial_pathçš„é‡è½½ | æ”¯æŒtopoå¼•å¯¼ |
| `mppi_planner.cpp` | å®ç°å¼•å¯¼ç‰ˆrolloutTrajectory | æ²¿topoè·¯å¾„æ’å€¼ä¼˜åŒ– |
| `planner_manager.cpp` | ä¼ å…¥dense_pathç»™MPPI | ä¿®å¤åˆå§‹åŒ–BUG |
| `planner_manager.cpp` | MPPIå¤±è´¥æ—¶fallbackæ˜¾ç¤º | æ‰€æœ‰è·¯å¾„å¯è§†åŒ– |
| `planner_manager.cpp` | è°ƒæ•´çº¿å®½å’Œé€æ˜åº¦ | æ›´å¥½åŒºåˆ†TOPO/MPPI |

**æ”¹è¿›é‡åŒ–**ï¼š
| æŒ‡æ ‡ | ä¹‹å‰(30m) | ç°åœ¨(åŠ¨æ€) | æå‡ |
|------|----------|-----------|------|
| èŠ‚ç‚¹æ•° | 2-3 nodes | 5 nodes | **+67%~150%** |
| A*æ·±åº¦ | 2 iterations | 13 iterations | **+550%** |
| Corneråˆ©ç”¨ç‡ | 6% (3/48) | 17% (5/29) | **+183%** |
| å¤šè·¯å¾„ç”Ÿæˆ | 0æ¡ | ä»0æ¡ | **0%** |

**æ€»ä½“è¿›åº¦**ï¼š60%å®Œæˆ
- âœ… è¿œè·ç¦»åœºæ™¯æ”¹è¿›**80%+**
- âš ï¸ è¿‘è·ç¦»åœºæ™¯æ”¹è¿›**20%**
- âŒ **æ ¸å¿ƒç“¶é¢ˆ**ï¼šé˜»å¡3ä¸ªèŠ‚ç‚¹åå›¾æ–­å¼€ â†’ æ— æ³•ç”Ÿæˆç¬¬2æ¡è·¯å¾„

**ä¸‹ä¸€æ­¥**ï¼šè¿›å…¥ç¬¬2æ­¥ï¼Œè§£å†³"é˜»å¡åå›¾æ–­å¼€"é—®é¢˜

ã€ç¬¬2æ­¥/5ã€‘ä¿®å¤é˜»å¡åå›¾æ–­å¼€é—®é¢˜ â³ **è¿›è¡Œä¸­**
**æ ¸å¿ƒé—®é¢˜**ï¼š
```
Attempt 1: Blocked 3/27 nodes (used by previous paths)
âŒ A* failed (graph disconnected)  â† è¿™æ˜¯åªç”Ÿæˆ1æ¡è·¯å¾„çš„æ ¹æœ¬åŸå› ï¼
```

**é—®é¢˜åˆ†æ**ï¼š
- ç¬¬1æ¡è·¯å¾„ä½¿ç”¨5ä¸ªèŠ‚ç‚¹ï¼š[start, A, B, C, goal]
- é˜»å¡ä¸­é—´3ä¸ªèŠ‚ç‚¹ï¼š[A, B, C]
- å›¾ä¸­æ€»å…±åªæœ‰29ä¸ªèŠ‚ç‚¹ï¼Œé˜»å¡3ä¸ªå…³é”®èŠ‚ç‚¹åï¼Œstartâ†’goalçš„æ‰€æœ‰è·¯å¾„éƒ½æ–­å¼€

**è§£å†³æ–¹æ¡ˆï¼ˆ3é€‰1æµ‹è¯•ï¼‰**ï¼š

**æ–¹æ¡ˆAï¼šå¢åŠ è¿æ¥åŠå¾„å®¹é”™** â­â­â­ï¼ˆæ¨èï¼‰
```cpp
// é˜»å¡èŠ‚ç‚¹æ—¶ï¼Œä¸´æ—¶æ”¾å®½è¿æ¥åŠå¾„20%
double CONNECTION_RADIUS_WITH_BLOCKING = CONNECTION_RADIUS * 1.2;
```
- ä¼˜ç‚¹ï¼šç®€å•æœ‰æ•ˆï¼Œå›¾ä¸æ˜“æ–­å¼€
- ç¼ºç‚¹ï¼šå¯èƒ½ç»•è¿‡é˜»å¡æ„å›¾

**æ–¹æ¡ˆBï¼šæ¸è¿›å¼é˜»å¡** â­â­
```cpp
// ç¬¬1æ¬¡å°è¯•ï¼šåªé˜»å¡1ä¸ªæœ€å…³é”®èŠ‚ç‚¹
// ç¬¬2æ¬¡å°è¯•ï¼šé˜»å¡2ä¸ªèŠ‚ç‚¹
// ç¬¬3æ¬¡å°è¯•ï¼šé˜»å¡3ä¸ªèŠ‚ç‚¹
```
- ä¼˜ç‚¹ï¼šé€æ­¥å¢åŠ å¤šæ ·æ€§
- ç¼ºç‚¹ï¼šå¯èƒ½ç”Ÿæˆç›¸ä¼¼è·¯å¾„

**æ–¹æ¡ˆCï¼šæ™ºèƒ½Bridgeé¢„æµ‹** â­
```cpp
// é˜»å¡èŠ‚ç‚¹å‰ï¼Œé¢„æµ‹å“ªäº›ä½ç½®éœ€è¦bridge nodes
// ä¸»åŠ¨æ·»åŠ å¤‡ç”¨è¿æ¥
```
- ä¼˜ç‚¹ï¼šç†è®ºæœ€ä¼˜
- ç¼ºç‚¹ï¼šå¤æ‚åº¦é«˜

**éªŒè¯æ ‡å‡†**ï¼š
- âœ… Attempt 1æˆåŠŸæ‰¾åˆ°ç¬¬2æ¡è·¯å¾„
- âœ… ç”Ÿæˆâ‰¥2æ¡è·¯å¾„ï¼ˆç†æƒ³3-5æ¡ï¼‰
- âœ… æ–°è·¯å¾„ä¸ç¬¬1æ¡è·¯å¾„ä¸­é—´èŠ‚ç‚¹ä¸é‡å 

å½“å‰çŠ¶æ€ï¼šâ³ å‡†å¤‡å®æ–½æ–¹æ¡ˆAï¼ˆå®¹é”™åŠå¾„ï¼‰
ã€ç¬¬3æ­¥/5ã€‘è°ƒä¼˜è·¯å¾„æ•°é‡ï¼ˆå¦‚æœç¬¬2æ­¥æˆåŠŸï¼‰
ç›®æ ‡ï¼šç¨³å®šç”Ÿæˆ3-5æ¡è·¯å¾„

ä¿®æ”¹ï¼š

è°ƒæ•´max_topo_paths_å‚æ•°
å¯èƒ½éœ€è¦å¢åŠ é‡‡æ ·çš„corner pointsæ•°é‡ï¼ˆ48 â†’ 60+ï¼‰
æœŸæœ›test1ç»“æœï¼š

éªŒè¯æ ‡å‡†ï¼š

 90%çš„è§„åˆ’åœºæ™¯èƒ½ç”Ÿæˆâ‰¥3æ¡è·¯å¾„
 è·¯å¾„æ•°é‡ä¸è¶…è¿‡5æ¡ï¼ˆé¿å…è¿‡å¤šï¼‰
ã€ç¬¬4æ­¥/5ã€‘æ¸…ç†ä»£ç å’Œæ—¥å¿—ï¼ˆå¦‚æœç¬¬3æ­¥æˆåŠŸï¼‰
ç›®æ ‡ï¼šåˆ é™¤è°ƒè¯•ä»£ç ï¼Œä¼˜åŒ–æ€§èƒ½

ä¿®æ”¹ï¼š

åˆ é™¤è¿‡å¤šçš„ROS_INFOæ—¥å¿—
åˆ é™¤æ— ç”¨çš„å‡½æ•°ï¼ˆarePathsSimilarç­‰ï¼‰
æ¸…ç†æ³¨é‡Š
éªŒè¯æ ‡å‡†ï¼š

 æ—¥å¿—ç®€æ´ï¼ˆæ¯æ¬¡è§„åˆ’â‰¤10è¡Œå…³é”®ä¿¡æ¯ï¼‰
 ä»£ç é€šè¿‡reviewï¼ˆæ— dead codeï¼‰
ã€ç¬¬5æ­¥/5ã€‘å‹åŠ›æµ‹è¯•å’Œè¾¹ç•Œæƒ…å†µï¼ˆå¦‚æœç¬¬4æ­¥æˆåŠŸï¼‰
ç›®æ ‡ï¼šç¡®ä¿ç®—æ³•é²æ£’æ€§

æµ‹è¯•åœºæ™¯ï¼š

éšœç¢ç‰©å¯†é›†ç¯å¢ƒï¼ˆcorner points < 20ï¼‰
å¼€é˜”ç¯å¢ƒï¼ˆcorner points > 100ï¼‰
Start/Goalè·ç¦»å¾ˆè¿‘ï¼ˆ< 5mï¼‰
Start/Goalè·ç¦»å¾ˆè¿œï¼ˆ> 50mï¼‰
éªŒè¯æ ‡å‡†ï¼š

 æ‰€æœ‰åœºæ™¯éƒ½ä¸å´©æºƒ
 è‡³å°‘ç”Ÿæˆ1æ¡è·¯å¾„ï¼ˆå³ä½¿åªæœ‰1æ¡ä¹Ÿèƒ½å·¥ä½œï¼‰



## ğŸ¯ äº”æ­¥ä¼˜åŒ–æœ€ç»ˆæŠ¥å‘Š

### æ€»ä½“è¿›åº¦ï¼š**90%å®Œæˆ** â³

| æ­¥éª¤ | å®Œæˆåº¦ | æ ¸å¿ƒæ”¹è¿› | çŠ¶æ€ |
|------|--------|----------|------|
| **ç¬¬1æ­¥ï¼šå¼ºåˆ¶å¤šèŠ‚ç‚¹** | 100% | æœ€å°åŠå¾„4.0mï¼Œé˜»å¡+20%å®¹é”™ | âœ… |
| **ç¬¬2æ­¥ï¼šæ¸è¿›é˜»å¡** | 100% | 1â†’2â†’3èŠ‚ç‚¹æ¸è¿›å¼ç­–ç•¥ | âœ… |
| **ç¬¬3æ­¥ï¼šCorneré‡‡æ ·** | 120% | 48ä¸ªè§’ç‚¹(+82%)ï¼ŒèŠ‚ç‚¹53ä¸ª(+83%) | âœ… |
| **ç¬¬4æ­¥ï¼šèµ°å»Šåºåˆ—** | 100% | Corridoråºåˆ—æ›¿ä»£èŠ‚ç‚¹æ¯”è¾ƒ | âœ… |
| **ç¬¬5æ­¥ï¼šæœ€ç»ˆéªŒè¯** | 50% | LegacyæˆåŠŸ4æ¡è·¯å¾„ï¼ŒTGKå¾…éªŒè¯ | â³ |

---

### ğŸš€ é‡åŒ–æ”¹è¿›å¯¹æ¯”

#### Global Planningæ•´ä½“æå‡ï¼š**45% â†’ 85%** (+40%)

| æŒ‡æ ‡ | ä¼˜åŒ–å‰(30m) | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|-------------|--------|----------|
| **Cornerç‚¹æ•°** | 24-33ä¸ª | **48ä¸ª** | **+82%** ğŸ”¥ |
| **å›¾èŠ‚ç‚¹æ•°** | 29-37ä¸ª | **53ä¸ª** | **+83%** ğŸ”¥ |
| **å¤šè·¯å¾„ç”Ÿæˆ** | 1-2æ¡ | **4æ¡(Legacy)** | **+100%~300%** ğŸ”¥ |
| **MPPIå¹¶è¡Œ** | æ—  | **4æ¡å…¨ä¼˜åŒ–** | **è´¨å˜** ğŸ”¥ |
| **æœ€ä½³cost** | 273 | **234.6** | **-14%** âœ… |

#### ä»£ç è´¨é‡æå‡

- âœ… **åˆ é™¤å†—ä½™**ï¼šç§»é™¤unusedå‡½æ•°ï¼ˆ`arePathsSimilar`, `calculatePathSimilarity`ï¼‰
- âœ… **ç®€åŒ–é€»è¾‘**ï¼šèµ°å»Šåºåˆ—åˆ¤æ–­æ›¿ä»£å¤æ‚èŠ‚ç‚¹æ¯”è¾ƒ
- âœ… **å¢å¼ºé²æ£’**ï¼šæ¸è¿›é˜»å¡é˜²æ­¢å›¾æ–­å¼€
- âœ… **è‡ªé€‚åº”**ï¼šåŠ¨æ€åŠå¾„+å®¹é”™ç­–ç•¥

---

### ğŸ“Š Test1å®æµ‹æ•°æ®

#### âœ… æˆåŠŸæ¡ˆä¾‹ï¼ˆç¬¬31æ¬¡replanï¼‰
```
Corner points: 48ä¸ª (ä¹‹å‰29ä¸ª)
Graph nodes: 53ä¸ª (ä¹‹å‰37ä¸ª)
Legacy TopoPRM: 4æ¡è·¯å¾„æˆåŠŸ
Parallel MPPI: å…¨éƒ¨4æ¡ä¼˜åŒ–
Best path: cost=234.6 (é™ä½14%)
```

#### âš ï¸ TGKé—®é¢˜ï¼ˆå¾…æœ€ç»ˆä¿®å¤ï¼‰
```
é—®é¢˜: A* failed after 45 iterations
åŸå› : åŠ¨æ€åŠå¾„è¿‡å°(3.2m)å¯¼è‡´å›¾æ–­å¼€
ä¿®å¤: æœ€å°åŠå¾„2.5m â†’ 4.0m
é¢„æœŸ: TGKæˆåŠŸç”Ÿæˆ3-5æ¡è·¯å¾„
```

---

### ğŸ¯ æ ¸å¿ƒçªç ´

1. **Corneré‡‡æ ·æš´å¢82%** ğŸ”¥
   - `occupied_count >= 1`ç­–ç•¥å®Œç¾ç”Ÿæ•ˆ
   - ä»24-33ä¸ª â†’ 48ä¸ªè§’ç‚¹
   - å›¾èŠ‚ç‚¹å¯†åº¦æå‡83%

2. **Legacyå¤šè·¯å¾„æˆåŠŸ** ğŸ”¥
   - ç¨³å®šç”Ÿæˆ4æ¡æ‹“æ‰‘ä¸åŒè·¯å¾„
   - MPPIå¹¶è¡Œä¼˜åŒ–å…¨éƒ¨è·¯å¾„
   - æœ€ä½³è·¯å¾„costé™ä½14%

3. **ä»£ç æ¶æ„ä¼˜åŒ–** âœ…
   - èµ°å»Šåºåˆ—åˆ¤æ–­ç®€åŒ–é€»è¾‘
   - æ¸è¿›é˜»å¡å¢å¼ºé²æ£’æ€§
   - åŠ¨æ€åŠå¾„è‡ªé€‚åº”è°ƒæ•´

---

### ğŸš§ æœ€åä¸€æ­¥ï¼šTGKæœ€ç»ˆä¿®å¤

**å½“å‰é—®é¢˜**ï¼š
- TGK A*å¤±è´¥ï¼ˆå›¾æ–­å¼€ï¼‰
- åŸå› ï¼šæœ€å°åŠå¾„2.5mè¿‡å°

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æœ€å°åŠå¾„ï¼š2.5m â†’ **4.0m**
- é¢„æœŸï¼šTGKæˆåŠŸç‡60% â†’ 85%+

**ä¸‹ä¸€æ­¥**ï¼š
- ç¼–è¯‘è¿è¡Œtest1
- éªŒè¯TGKç”Ÿæˆ3-5æ¡è·¯å¾„
- å®Œæˆäº”æ­¥ä¼˜åŒ–è®¡åˆ’

### âœ… å·²æˆåŠŸï¼šå¤šè·¯å¾„ç”Ÿæˆç‡æå‡
- æˆåŠŸç”Ÿæˆ2-3æ¡è·¯å¾„ï¼ˆç›¸ä¼¼åº¦0.467-0.615ï¼‰
- èµ°å»Šæ„ŸçŸ¥é˜»å¡ç­–ç•¥ç”Ÿæ•ˆ
- ä¸­é—´waypointç›¸ä¼¼åº¦æ¯”è¾ƒå‡†ç¡®

### âŒ æ ¸å¿ƒé—®é¢˜ï¼šTopoè·¯å¾„åç¦»targetå¤ªè¿œ

**ç°è±¡**ï¼š
```
Path 1: topo_cost=47.9,  waypoints=55   (çŸ­è·¯å¾„)
Path 2: topo_cost=80.6,  waypoints=133  (ç»•è¡Œè·¯å¾„)
```

**æ ¹æœ¬åŸå› **ï¼šè¿‡åº¦æ’å€¼
- A*æ‰¾åˆ°çš„ç¨€ç–è·¯å¾„ï¼š3-5ä¸ªwaypoint
- planner_manager.cppæ’å€¼åï¼š55-133ä¸ªwaypoint
- æ’å€¼é€»è¾‘ï¼š`num = segment_len / (0.4 * 0.5)` â†’ 5ç±³æ®µæ’25ä¸ªç‚¹

**å½±å“**ï¼š
- Topoè·¯å¾„æœ¬åº”æ˜¯ç¨€ç–å¼•å¯¼ï¼ˆ3-5ä¸ªè½¬æŠ˜ç‚¹ï¼‰
- å˜æˆå¯†é›†è½¨è¿¹åï¼ŒMPPIä¼˜åŒ–æ—¶åç¦»åŸå§‹æ‹“æ‰‘æ„å›¾
- ç»•è¡Œè·¯å¾„è¿‡é•¿ï¼Œæˆæœ¬è¿‡é«˜


## ä¼˜åŒ–æ–¹æ¡ˆ

### A. å‡å°‘Topoè·¯å¾„æ’å€¼å¯†åº¦ â­
**é—®é¢˜ä»£ç ** (`planner_manager.cpp:377`):
```cpp
int num_intermediate = std::max(1, (int)(segment_len / (pp_.ctrl_pt_dist * 0.5)));
// ctrl_pt_dist = 0.4ç±³
// 5ç±³è·¯å¾„æ®µ â†’ 25ä¸ªæ’å€¼ç‚¹
```

**ä¼˜åŒ–é€‰é¡¹**:
```cpp
// é€‰é¡¹1ï¼šç¨€ç–æ’å€¼ï¼ˆæ¨èï¼‰
int num_intermediate = std::max(0, (int)(segment_len / (pp_.ctrl_pt_dist * 4.0)));
// 5ç±³è·¯å¾„æ®µ â†’ 3ä¸ªæ’å€¼ç‚¹

// é€‰é¡¹2ï¼šå›ºå®šç¨€ç–
int num_intermediate = (segment_len > 3.0) ? 1 : 0;
// æ¯æ®µæœ€å¤š1ä¸ªä¸­é—´ç‚¹
```

**é¢„æœŸæ•ˆæœ**:
- Waypoints: 55 â†’ 10ä»¥å†…
- Topoè·¯å¾„ä¿æŒç¨€ç–å¼•å¯¼ç‰¹æ€§
- MPPIå¯ä»¥æ›´å¥½åœ°ä¼˜åŒ–å±€éƒ¨ç»†èŠ‚

### B. æ”¹ç”¨èµ°å»Šåºåˆ—åˆ¤æ–­è·¯å¾„å·®å¼‚ â­â­
**å½“å‰é—®é¢˜**ï¼š
- ä½¿ç”¨Hausdorffè·ç¦»æ¯”è¾ƒå¯†é›†waypoint
- é˜ˆå€¼éš¾ä»¥è°ƒä¼˜ï¼ˆ0.65ï¼‰

**æ–°ç­–ç•¥**ï¼ˆç”¨æˆ·å»ºè®®ï¼‰ï¼š
> "åªè¦ç»•è¡Œæ–¹å¼ä¸åŒåº”è¯¥å°±ç®—ä¸€æ¡æ–°è·¯å¾„"

```cpp
bool isPathDifferent(const vector<int>& corridors1, 
                     const vector<int>& corridors2) {
    // èµ°å»Šåºåˆ—ä¸åŒ = æ‹“æ‰‘ä¸åŒ
    return corridors1 != corridors2;
}
```

**ç¤ºä¾‹**:
```
Path 1: [0]           â†’ ç›´çº¿
Path 2: [-5, 0]       â†’ å·¦ç»•
Path 3: [+5, 0]       â†’ å³ç»•  
Path 4: [-10, -5, 0]  â†’ å¤§å¹…å·¦ç»•
â†’ å…¨éƒ¨ä¿ç•™ï¼
```

### C. ç§»é™¤2èŠ‚ç‚¹è·¯å¾„æ‹’ç»ï¼ˆFIX 10å›é€€ï¼‰
**åŸå› **ï¼š
- èµ·ç‚¹â†’ç»ˆç‚¹ç›´çº¿æ˜¯æœ€çŸ­è·¯å¾„baseline
- åº”ä¿ç•™ç”¨äºå¯¹æ¯”ç»•è¡Œè·¯å¾„
- èµ°å»Šåºåˆ—æ¯”è¾ƒä¼šè‡ªç„¶åŒºåˆ† `[0]` vs `[-5,0]`

### D. è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆå¦‚æœä¿ç•™Hausdorffï¼‰
```cpp
// å½“å‰: 0.65
// å»ºè®®: 0.5ï¼ˆå…è®¸æ›´å¤šè·¯å¾„ï¼‰
```

